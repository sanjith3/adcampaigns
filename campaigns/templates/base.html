<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AdSoft</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

     
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Google Fonts for Hologram Theme -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&display=swap" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="{% static 'css/adsoft-theme.css' %}?v=20251003" rel="stylesheet">
    <link href="{% static 'css/custom.css' %}?v=20251003" rel="stylesheet">
    <link href="{% static 'css/responsive.css' %}?v=20251003" rel="stylesheet">

    <!-- Theme CSS -->
    <link href="{% static 'css/dark-theme.css' %}?v=20251003" rel="stylesheet">

    {% block extra_css %}{% endblock %}

</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="{% url 'dashboard' %}">AdSoft</a>
            <div class="navbar-nav ms-auto">
                {% if user.is_authenticated %}
                    <span class="navbar-text me-3">Hello, {{ user.username }}</span>
                    {% if user.is_superuser %}
                        <a class="nav-link" href="{% url 'admin_dashboard' %}">Admin Dashboard</a>
                        <a class="nav-link" href="{% url 'admin_users' %}">Manage Users</a>
                    {% endif %}
                    <!-- Change logout to use POST form -->
                    <form method="post" action="{% url 'logout' %}" class="d-inline">
                        {% csrf_token %}
                        <button type="submit" class="nav-link btn btn-link" style="border: none; background: none; color: rgba(255,255,255,.55); padding: 0.5rem 1rem;">
                            Logout
                        </button>
                    </form>
                {% else %}
                    <a class="nav-link" href="{% url 'login' %}">Login</a>
                {% endif %}
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}

        {% block content %}
        {% endblock %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Custom JS -->
    <script src="{% static 'js/main.js' %}?v=20251003"></script>
    <script src="{% static 'js/dashboard.js' %}?v=20251003"></script>
    <script src="{% static 'js/theme-switcher.js' %}?v=20251003"></script>
    
    {% block extra_js %}
    <script>
    (function() {
        let errorCount = 0;
        let pollTimer = null;

        function updateFollowBadge(count) {
            const adminBadge = document.getElementById('admin-follow-badge');
            const userBadge  = document.getElementById('user-follow-badge');
            [adminBadge, userBadge].forEach(function(el) {
                if (!el) return;
                if (count > 0) {
                    el.textContent = count;
                    el.style.display = 'inline-block';
                } else {
                    el.textContent = '';
                    el.style.display = 'none';
                }
            });
        }

        async function fetchCounts() {
            if (document.hidden) {
                scheduleNext(20000);
                return;
            }
            try {
                const resp = await fetch('/dashboard/notifications/', { credentials: 'same-origin' });
                if (!resp.ok) throw new Error('Failed to fetch notifications');
                const data = await resp.json();
                if (data && typeof data.follow_up_count === 'number') {
                    updateFollowBadge(data.follow_up_count);
                }
                scheduleNext(20000);
            } catch (e) {
                console.warn('Notification poll error:', e);
                errorCount++;
                const retryDelay = Math.min(5, errorCount) * 20000;
                scheduleNext(retryDelay);
            }
        }

        function scheduleNext(ms) {
            clearTimeout(pollTimer);
            pollTimer = setTimeout(fetchCounts, ms);
        }

        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                clearTimeout(pollTimer);
                fetchCounts();
            }
        });

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', fetchCounts);
        } else {
            fetchCounts();
        }

        // FIXED: Better modal cleanup that only removes stuck overlays
        function cleanupModalArtifacts() {
            const anyModalVisible = document.querySelector('.modal.show');
            
            // If no modal is actually visible but body has modal-open class
            if (!anyModalVisible && document.body.classList.contains('modal-open')) {
                console.log('Cleaning up stuck modal state');
                document.body.classList.remove('modal-open');
                document.body.style.overflow = '';
                document.body.style.paddingRight = '';
                
                // Only remove backdrops that are actually stuck (no parent modal)
                const backdrops = document.querySelectorAll('.modal-backdrop');
                backdrops.forEach(backdrop => {
                    const hasParentModal = backdrop.closest('.modal');
                    if (!hasParentModal && backdrop.parentNode) {
                        backdrop.parentNode.removeChild(backdrop);
                    }
                });
            }
        }

        // Run cleanup on various events
        const cleanupEvents = ['DOMContentLoaded', 'pageshow', 'load'];
        cleanupEvents.forEach(event => {
            window.addEventListener(event, function() {
                // Small delay to ensure page is fully loaded
                setTimeout(cleanupModalArtifacts, 100);
            });
        });

        // Also cleanup when coming back to the page
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                setTimeout(cleanupModalArtifacts, 50);
            }
        });

        // Emergency cleanup - if user clicks anywhere and overlay is stuck
        document.addEventListener('click', function(e) {
            // If clicking on body and modal-open class is present but no visible modals
            if (e.target === document.body && 
                document.body.classList.contains('modal-open') && 
                !document.querySelector('.modal.show')) {
                cleanupModalArtifacts();
            }
        });

    })();
    </script>
    {% endblock %}
</body>
</html>