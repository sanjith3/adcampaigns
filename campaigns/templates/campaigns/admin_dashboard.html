{% extends 'base.html' %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div id="new-enquiries-banner" class="alert alert-info d-none" role="alert">
            <i class="fas fa-bell"></i>
            New enquiries are available.
            <a href="?status=enquiry" class="btn btn-sm btn-outline-primary ms-2">View Enquiries</a>
            <a href="?status=all" class="btn btn-sm btn-outline-dark ms-1">View All Ads</a>
        </div>
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                {% if show_follow %}
                    <i class="fas fa-bell"></i> Follow-up List
                {% else %}
                    <i class="fas fa-shield-alt"></i> Admin Dashboard
                {% endif %}
            </h1>
            <div class="d-flex align-items-center gap-2">
                <span class="badge bg-primary me-2">Total Ads: {{ status_counts.all }}</span>
                <span class="badge bg-secondary me-2">Enquiries: {{ status_counts.enquiry }}</span>
                <span class="badge bg-dark me-2">Hold: {{ status_counts.hold }}</span>
                <span class="badge bg-warning me-2">Pending: {{ status_counts.pending }}</span>
                <span class="badge bg-success me-2">Active: {{ status_counts.active }}</span>
                <span class="badge bg-info">Completed: {{ status_counts.completed }}</span>
            </div>
        </div>

        <div class="mb-3 d-flex gap-2">
            <a href="{% url 'admin_users' %}" class="btn btn-outline-dark">
                <i class="fas fa-users"></i> Manage Users
            </a>
            <a href="#" id="admin-generate-report" class="btn btn-outline-success">
                <i class="fas fa-paper-plane"></i> Generate Report
            </a>
            {% if show_follow %}
                <a href="?status={{ status_filter }}" class="btn btn-outline-primary">
                    <i class="fas fa-chart-line"></i> Back to Dashboard
                </a>
            {% else %}
                <a href="?status={{ status_filter }}&view=follow" class="btn btn-primary position-relative">
                    <i class="fas fa-bell"></i> Follow-up
                    <span id="admin-follow-badge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="display:none;"></span>
                </a>
            {% endif %}
        </div>

        <!-- Completed Campaigns History Section - Always Visible -->


        {% if not show_follow %}
        <!-- Stats Row -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-white bg-success">
                    <div class="card-body text-center">
                        <h5 class="card-title">{{ stats_active_today_count }}</h5>
                        <p class="card-text mb-0">Active Today</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-primary">
                    <div class="card-body text-center">
                        <h5 class="card-title">₹{{ stats_active_today_amount }}</h5>
                        <p class="card-text mb-0">Amount Total (Today)</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title">Active Range Filter</h6>
                        <form method="get" class="row g-2">
                            <input type="hidden" name="status" value="{{ status_filter }}" />
                            {% if user_filter %}
                            <input type="hidden" name="user" value="{{ user_filter }}" />
                            {% endif %}
                            <div class="col-5">
                                <input type="date" name="start" value="{{ stats_range_start }}" class="form-control form-control-sm" placeholder="Start" />
                            </div>
                            <div class="col-5">
                                <input type="date" name="end" value="{{ stats_range_end }}" class="form-control form-control-sm" placeholder="End" />
                            </div>
                            <div class="col-2 d-grid">
                                <button type="submit" class="btn btn-outline-primary btn-sm">Filter</button>
                            </div>
                            {% if stats_range_count != None %}
                            <div class="col-12 mt-2">
                                <div class="alert alert-info py-1 mb-0 small">
                                    <strong>{{ stats_range_count }}</strong> active in range, total <strong>₹{{ stats_range_amount }}</strong>
                                </div>
                            </div>
                            {% endif %}
                        </form>
                 
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title">Completed Campaigns History</h6>
                        <form method="get" class="row g-2">
                            <input type="hidden" name="status" value="{{ status_filter }}" />
                            {% if user_filter %}
                            <input type="hidden" name="user" value="{{ user_filter }}" />
                            {% endif %}
                            <div class="col-5">
                                <input type="date" name="history_start" value="{{ history_start }}" class="form-control form-control-sm" placeholder="Start" />
                            </div>
                            <div class="col-5">
                                <input type="date" name="history_end" value="{{ history_end }}" class="form-control form-control-sm" placeholder="End" />
                            </div>
                            <div class="col-2 d-grid">
                                <button type="submit" class="btn btn-outline-info btn-sm">Filter</button>
                            </div>
                            {% if completed_history %}
                            <div class="col-12 mt-2">
                                <div class="alert alert-info py-1 mb-0 small">
                                    <strong>{{ completed_history.count }}</strong> campaigns completed in this date range
                                </div>
                            </div>
                            {% endif %}
                        </form>
                        <div class="mb-2">
                            <a href="?status={{ status_filter }}&quick_filter=yesterday{% if user_filter %}&user={{ user_filter }}{% endif %}" class="btn btn-outline-warning btn-sm me-1 {% if quick_filter == 'yesterday' %}active{% endif %}" data-filter="yesterday">
                                <i class="fas fa-calendar-day me-1"></i>Yesterday
                            </a>
                            <a href="?status={{ status_filter }}&quick_filter=before_yesterday{% if user_filter %}&user={{ user_filter }}{% endif %}" class="btn btn-outline-warning btn-sm {% if quick_filter == 'before_yesterday' %}active{% endif %}" data-filter="before_yesterday">
                                <i class="fas fa-calendar-minus me-1"></i>Before Yesterday
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
        {% endif %}

        {% if show_follow %}
        <!-- Follow-up Table Only View -->
        <div class="card">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0"><i class="fas fa-bell"></i> Follow-up Needed ({{ follow_up_ads.count }})</h5>
            </div>
            <div class="card-body">
                {% if follow_up_ads %}
                <div class="table-responsive">
                    <table class="table table-hover table-striped">
                        <thead class="table-dark">
                            <tr>
                                <th>Ad Name</th>
                                <th>Business</th>
                                <th>Employee</th>
                                <th>Completed On</th>
                                <th>Notes</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ad in follow_up_ads %}
                            <tr>
                                <td>{{ ad.ad_name }}</td>
                                <td>{{ ad.business_name }}</td>
                                <td>
                                    {% if ad.user %}
                                        {{ ad.user.get_full_name|default:ad.user.username }}
                                    {% else %}
                                        <span class="text-muted">(deleted user)</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if ad.end_date %}
                                        {{ ad.end_date|date:"M d, Y" }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>{{ ad.notes|default:"No notes" }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> No follow-ups needed.
                </div>
                {% endif %}
            </div>
        </div>
        {% elif quick_filter %}
        <!-- Show completed history when yesterday/before yesterday filter is used -->
        <div class="alert alert-info">
            <i class="fas fa-info-circle"></i> Showing campaigns that were <strong>completed</strong> on 
            {% if quick_filter == 'yesterday' %}
                yesterday
            {% elif quick_filter == 'before_yesterday' %}
                before yesterday
            {% endif %}
        </div>
        
        <!-- Always show the data table structure -->
        <div class="card mt-3">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i class="fas fa-check-circle"></i> Completed Campaigns History
                    {% if completed_history %}
                        ({{ completed_history.count }})
                    {% else %}
                        (0)
                    {% endif %}
                </h5>
            </div>
            <div class="card-body">
                {% if completed_history %}
                <div class="table-responsive">
                    <table class="table table-hover table-striped">
                        <thead class="table-dark">
                            <tr>
                                <th>Ad Name</th>
                                <th>Business</th>
                                <th>Employee</th>
                                <th>Amount</th>
                                <th>Entry Date</th>
                                <th>Start Date</th>
                                <th>End Date</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in completed_history %}
                            <tr>
                                <td>{{ item.ad_name }}</td>
                                <td>{{ item.business_name }}</td>
                                <td>
                                    {% if item.user %}
                                        {{ item.user.get_full_name|default:item.user.username }}
                                    {% else %}
                                        <span class="text-muted">(deleted user)</span>
                                    {% endif %}
                                </td>
                                <td>{% if item.amount %}₹{{ item.amount }}{% else %}-{% endif %}</td>
                                <td>{{ item.entry_date|date:"M d, Y H:i" }}</td>
                                <td>{% if item.start_date %}{{ item.start_date|date:"M d, Y" }}{% else %}-{% endif %}</td>
                                <td>{% if item.end_date %}{{ item.end_date|date:"M d, Y" }}{% else %}-{% endif %}</td>
                                <td>
                                    <span class="badge bg-{{ item.get_status_display_class }}">{{ item.get_status_display }}</span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <!-- Show empty state with notification -->
                <div class="alert alert-warning d-flex align-items-center">
                    <i class="fas fa-exclamation-triangle me-3 fs-4"></i>
                    <div>
                        <h6 class="mb-1">No Data Found</h6>
                        <p class="mb-0">
                            No campaigns were completed on 
                            {% if quick_filter == 'yesterday' %}
                                <strong>yesterday</strong>
                            {% elif quick_filter == 'before_yesterday' %}
                                <strong>before yesterday</strong>
                            {% endif %}.
                            <br>
                            <small class="text-muted">Try selecting a different date range or check if campaigns were completed on other days.</small>
                        </p>
                    </div>
                </div>
                
                <!-- Show empty table structure for consistency -->
                <div class="table-responsive">
                    <table class="table table-hover table-striped">
                        <thead class="table-dark">
                            <tr>
                                <th>Ad Name</th>
                                <th>Business</th>
                                <th>Employee</th>
                                <th>Amount</th>
                                <th>Entry Date</th>
                                <th>Start Date</th>
                                <th>End Date</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="8" class="text-center text-muted py-4">
                                    <i class="fas fa-inbox fa-2x mb-2 d-block"></i>
                                    No completed campaigns found for this date
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                {% endif %}
            </div>
        </div>
        {% elif completed_history %}
        <!-- Only show completed history when date range filter is used -->
        <div class="alert alert-info">
            <i class="fas fa-info-circle"></i> Showing campaigns that were <strong>completed</strong> between {{ history_start }} and {{ history_end }}
        </div>
        <div class="mt-3">
            {% include 'campaigns/_ad_history.html' with subject_ad=None history_ads=completed_history %}
        </div>
        {% else %}

        <!-- Status and User Filters -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row g-2 align-items-end">
                    <div class="col-md-8">
                        <h6 class="card-title">Filter by Status:</h6>
                        <div class="btn-group" role="group">
                            <a href="?status=all{% if user_filter %}&user={{ user_filter }}{% endif %}" class="btn btn-outline-primary {% if status_filter == 'all' %}active{% endif %}">
                                All Ads
                            </a>
                            <a href="?status=enquiry{% if user_filter %}&user={{ user_filter }}{% endif %}" class="btn btn-outline-secondary {% if status_filter == 'enquiry' %}active{% endif %}">
                                Enquiries ({{ status_counts.enquiry }})
                            </a>
                            <a href="?status=hold{% if user_filter %}&user={{ user_filter }}{% endif %}" class="btn btn-outline-dark {% if status_filter == 'hold' %}active{% endif %}">
                                Hold ({{ status_counts.hold }})
                            </a>
                            <a href="?status=pending{% if user_filter %}&user={{ user_filter }}{% endif %}" class="btn btn-outline-warning {% if status_filter == 'pending' %}active{% endif %}">
                                Pending ({{ status_counts.pending }})
                            </a>
                            <a href="?status=active{% if user_filter %}&user={{ user_filter }}{% endif %}" class="btn btn-outline-success {% if status_filter == 'active' %}active{% endif %}">
                                Active ({{ status_counts.active }})
                            </a>
                            <a href="?status=completed{% if user_filter %}&user={{ user_filter }}{% endif %}" class="btn btn-outline-info {% if status_filter == 'completed' %}active{% endif %}">
                                Completed ({{ status_counts.completed }})
                            </a>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Filter by User</label>
                        <form method="get" class="d-flex gap-2">
                            <input type="hidden" name="status" value="{{ status_filter }}" />
                            <select name="user" class="form-select">
                                <option value="">All Users</option>
                                {% for u in users_for_filter %}
                                <option value="{{ u.id }}" {% if user_filter|default:'' == u.id|stringformat:'s' %}selected{% endif %}>
                                    {{ u.get_full_name|default:u.username }}
                                </option>
                                {% endfor %}
                            </select>
                            <button type="submit" class="btn btn-primary">Apply</button>
                        </form>
                        {% if selected_user %}
                        <div class="small text-muted mt-1">Showing records for: <strong>{{ selected_user.get_full_name|default:selected_user.username }}</strong></div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- All Ads Table -->
        <div class="card">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0 d-flex align-items-center justify-content-between">
                    <i class="fas fa-list"></i>
                    {% if status_filter == 'all' %}
                        All Ad Campaigns
                    {% else %}
                        {{ status_filter|title }} Campaigns
                    {% endif %}
                    ({{ all_ads.count }})
                    {% if status_filter == 'active' or status_filter == 'completed' %}
                    <span class="badge bg-primary ms-2">Total Amount: ₹{{ filtered_total_amount }}</span>
                    {% endif %}
                </h5>
            </div>
            <div class="card-body">
                {% if all_ads %}
                <div class="table-responsive">
                    <table class="table table-hover table-striped">
                        <thead class="table-dark">
                            <tr>
                                <th>Ad Name</th>
                                <th>Business</th>
                                <th>Mobile Number</th>
                                <th>Status</th>
                                <th>Amount</th>
                                <th>Employee</th>
                                <th>Entry Date</th>
                                <th>Start Date</th>
                                <th>End Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ad in all_ads %}
                            <tr>
                                <td>{{ ad.ad_name }}</td>
                                <td>{{ ad.business_name }}</td>
                                <td>{{ ad.mobile_number }}</td>
                                <td>
                                    <span class="badge bg-{{ ad.get_status_display_class }}">
                                        {{ ad.get_status_display }}
                                    </span>
                                </td>
                                <td>
                                    {% if ad.amount %}
                                        ₹{{ ad.amount }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>
                                    {% if ad.user %}
                                        {{ ad.user.username }}
                                    {% else %}
                                        <span class="text-muted">(deleted user)</span>
                                    {% endif %}
                                </td>
                                <td>{{ ad.entry_date|date:"M d, Y" }}</td>
                                <td>
                                    {% if ad.start_date %}
                                        {{ ad.start_date|date:"M d, Y" }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>
                                    {% if ad.end_date %}
                                        {{ ad.end_date|date:"M d, Y" }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>
                                    {% if ad.status == 'enquiry' %}
                                        <span class="text-muted">Waiting for payment</span>
                                        <a href="{% url 'admin_edit_enquiry' ad.id %}" class="btn btn-sm btn-outline-secondary">
                                            <i class="fas fa-edit"></i> Edit
                                        </a>
                                    {% elif ad.status == 'hold' %}
                                        <span class="text-muted">On Hold</span>
                                        <a href="{% url 'admin_edit_hold' ad.id %}" class="btn btn-sm btn-outline-secondary">
                                            <i class="fas fa-edit"></i> Edit
                                        </a>
                                    {% elif ad.status == 'pending' %}
                                        <a href="{% url 'verify_payment' ad.id %}" class="btn btn-sm btn-warning">
                                            <i class="fas fa-check-circle"></i> Verify
                                        </a>
                                    {% elif ad.status == 'active' %}
                                        <span class="text-success">Active</span>
                                    {% elif ad.status == 'completed' %}
                                        <span class="text-info">Completed</span>
                                    {% endif %}

                                    <!-- View details button for all ads -->
                                    <button class="btn btn-sm btn-info" data-bs-toggle="modal" data-bs-target="#adDetailsModal{{ ad.id }}">
                                        <i class="fas fa-eye"></i> View
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary" data-action="history" data-ad-id="{{ ad.id }}" data-bs-toggle="modal" data-bs-target="#adHistoryModal" >
                                        <i class="fas fa-clock-rotate-left"></i> History
                                    </button>
                                </td>
                            </tr>

                            <!-- Details Modal -->
                            <div class="modal fade" id="adDetailsModal{{ ad.id }}" tabindex="-1">
                                <div class="modal-dialog modal-lg">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title">Ad Details: {{ ad.ad_name }}</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                        </div>
                                        <div class="modal-body">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <h6>Basic Information</h6>
                                                    <p><strong>Ad Name:</strong> {{ ad.ad_name }}</p>
                                                    <p><strong>Business:</strong> {{ ad.business_name }}</p>
                                                    <p><strong>Status:</strong>
                                                        <span class="badge bg-{{ ad.get_status_display_class }}">
                                                            {{ ad.get_status_display }}
                                                        </span>
                                                    </p>
                                                    <p><strong>Employee:</strong>
                                                        {% if ad.user %}
                                                            {{ ad.user.get_full_name|default:ad.user.username }}
                                                        {% else %}
                                                            <span class="text-muted">(deleted user)</span>
                                                        {% endif %}
                                                    </p>
                                                </div>
                                                <div class="col-md-6">
                                                    <h6>Dates</h6>
                                                    <p><strong>Entry Date:</strong> {{ ad.entry_date|date:"M d, Y H:i" }}</p>
                                                    <p><strong>Start Date:</strong>
                                                        {% if ad.start_date %}
                                                            {{ ad.start_date|date:"M d, Y" }}
                                                        {% else %}
                                                            Not started
                                                        {% endif %}
                                                    </p>
                                                    <p><strong>End Date:</strong>
                                                        {% if ad.end_date %}
                                                            {{ ad.end_date|date:"M d, Y" }}
                                                        {% else %}
                                                            Not set
                                                        {% endif %}
                                                    </p>
                                                </div>
                                            </div>

                                            <hr>

                                            <div class="row">
                                                <div class="col-md-6">
                                                    <h6>Payment Information</h6>
                                                    <p><strong>Amount:</strong>
                                                        {% if ad.amount %}
                                                            ₹{{ ad.amount }}
                                                        {% else %}
                                                            Not set
                                                        {% endif %}
                                                    </p>
                                                    <p><strong>Last 4 UPI Digits:</strong>
                                                        {% if ad.upi_last_four %}
                                                            {{ ad.upi_last_four }}
                                                        {% else %}
                                                            Not provided
                                                        {% endif %}
                                                    </p>
                                                    <p><strong>Admin UPI ID:</strong>
                                                        {% if ad.admin_upi_id %}
                                                            {{ ad.admin_upi_id }}
                                                        {% else %}
                                                            Not verified
                                                        {% endif %}
                                                    </p>
                                                </div>
                                                <div class="col-md-6">
                                                    <h6>Notes</h6>
                                                    <p>{{ ad.notes|default:"No notes provided" }}</p>
                                                </div>
                                            </div>

                                            {% if ad.renewed_from %}
                                            <hr>
                                            <div class="row">
                                                <div class="col-12">
                                                    <h6>Renewal History</h6>
                                                    <p class="text-muted">
                                                        Renewed from: {{ ad.renewed_from.ad_name }}
                                                        (Completed on {{ ad.renewed_from.end_date|date:"M d, Y" }})
                                                    </p>
                                                </div>
                                            </div>
                                            {% endif %}
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    {% if status_filter == 'all' %}
                        No ad campaigns found.
                    {% else %}
                        No {{ status_filter }} campaigns found.
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Quick Stats Cards -->
        <div class="row mt-4">
            <div class="col-md-3">
                <div class="card text-white bg-primary">
                    <div class="card-body text-center">
                        <h5 class="card-title">{{ status_counts.all }}</h5>
                        <p class="card-text">Total Ads</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-warning">
                    <div class="card-body text-center">
                        <h5 class="card-title">{{ status_counts.pending }}</h5>
                        <p class="card-text">Pending Verification</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-success">
                    <div class="card-body text-center">
                        <h5 class="card-title">{{ status_counts.active }}</h5>
                        <p class="card-text">Active Campaigns</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-info">
                    <div class="card-body text-center">
                        <h5 class="card-title">{{ status_counts.completed }}</h5>
                        <p class="card-text">Completed</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- History Modal -->
        <div class="modal fade" id="adHistoryModal" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Client History</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body" id="ad-history-body">
                        <div class="text-center text-muted py-4">Loading...</div>
                    </div>
                </div>
            </div>
        </div>

        <script>
        document.addEventListener('click', function(e){
            var btn = e.target.closest('button[data-action="history"][data-ad-id]');
            if(!btn) return;
            var adId = btn.getAttribute('data-ad-id');
            var body = document.getElementById('ad-history-body');
            if (body) {
                body.innerHTML = '<div class="text-center text-muted py-4">Loading...</div>';
                fetch('/dashboard/admin-ad-history/' + adId + '/', {credentials:'same-origin'})
                    .then(function(r){ return r.text(); })
                    .then(function(html){ body.innerHTML = html; })
                    .catch(function(){ body.innerHTML = '<div class="alert alert-danger">Failed to load history.</div>'; });
            }
        });
        </script>

        {% if completed_history %}
        <!-- Completed History Table -->
        <div class="card mt-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-check-circle"></i> Completed Campaigns History ({{ completed_history.count }})</h5>
            </div>
        
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover table-striped">
                        <thead class="table-dark">
                            <tr>
                                <th>Ad Name</th>
                                <th>Business</th>
                                <th>Employee</th>
                                <th>Amount</th>
                                <th>Campaign Started</th>
                                <th>Campaign Ended</th>
                                <th>Duration</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ad in completed_history %}
                            <tr>
                                <td>{{ ad.ad_name }}</td>
                                <td>{{ ad.business_name }}</td>
                                <td>
                                    {% if ad.user %}
                                        {{ ad.user.get_full_name|default:ad.user.username }}
                                    {% else %}
                                        <span class="text-muted">(deleted user)</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if ad.amount %}
                                        ₹{{ ad.amount }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>
                                    {% if ad.start_date %}
                                        {{ ad.start_date|date:"M d, Y" }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>
                                    {% if ad.end_date %}
                                        {{ ad.end_date|date:"M d, Y" }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>
                                    {% if ad.start_date and ad.end_date %}
                                        {{ ad.get_duration_days }} days
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}
        {% endif %}
    </div>
</div>

{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
(function() {
    // Generate Report button handler
    document.addEventListener('click', function(e) {
        var generateBtn = e.target.closest('#admin-generate-report');
        if (!generateBtn) return;
        e.preventDefault();
        var originalHtml = generateBtn.innerHTML;
        generateBtn.disabled = true;
        generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';

        fetch('/dashboard/generate-report/', { credentials: 'same-origin' })
            .then(function(resp){ return resp.json(); })
            .then(function(data){
                if (data && data.ok) {
                    alert('Report generated and emailed successfully.');
                } else {
                    alert('Failed to generate report' + (data && data.error ? ': ' + data.error : '.'));
                }
            })
            .catch(function(err){
                alert('Error generating report: ' + err);
            })
            .finally(function(){
                generateBtn.disabled = false;
                generateBtn.innerHTML = originalHtml;
            });
    });

    const pollUrl = "{% url 'poll_admin_status' %}";
    let currentToken = null;
    let lastCounts = null;

    // Schedule next poll after a delay
    function scheduleNext(delayMs) {
        setTimeout(pollOnce, delayMs);
    }

    async function pollOnce() {
        try {
            const url = new URL(pollUrl, window.location.origin);
            if (currentToken) url.searchParams.set('token', currentToken);

            const resp = await fetch(url.toString(), { credentials: 'same-origin' });
            if (!resp.ok) throw new Error('Poll failed');

            const data = await resp.json();
            if (!data || typeof data.token !== 'string') throw new Error('Invalid response');

            const banner = document.getElementById('new-enquiries-banner');
            const params = new URLSearchParams(window.location.search);
            const currentFilter = params.get('status') || 'all';

            if (data.counts) {
                // Show banner for new enquiries if needed
                if (lastCounts 
                    && data.counts.enquiry > lastCounts.enquiry 
                    && currentFilter !== 'enquiry' 
                    && currentFilter !== 'all') {
                    if (banner) banner.classList.remove('d-none');
                }
                lastCounts = data.counts;
            }

            // Reload page only if a real change occurred and token changed
            // Also refresh when viewing the Hold filter so the Hold table stays live
            if (currentToken && data.changed && (currentFilter === 'enquiry' || currentFilter === 'hold' || currentFilter === 'all')) {
                window.location.reload();
                return; // stop further polling on this execution
            }

            currentToken = data.token; // update token
            scheduleNext(1000); // poll again after 1s

        } catch (e) {
            console.warn('Admin poll error:', e);
            scheduleNext(5000); // retry after 5s on error
        }
    }

    // Start polling after DOM ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', pollOnce);
    } else {
        pollOnce();
    }

    // Add click handlers for yesterday/before yesterday buttons
    document.addEventListener('click', function(e) {
        const yesterdayBtn = e.target.closest('a[href*="quick_filter=yesterday"]');
        const beforeYesterdayBtn = e.target.closest('a[href*="quick_filter=before_yesterday"]');
        
        if (yesterdayBtn) {
            showNotification('Filtering for campaigns completed yesterday...', 'info');
        } else if (beforeYesterdayBtn) {
            showNotification('Filtering for campaigns completed before yesterday...', 'info');
        }
    });

    // Function to show toast notifications
    function showNotification(message, type = 'info') {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        notification.innerHTML = `
            <i class="fas fa-${type === 'info' ? 'info-circle' : 'exclamation-triangle'} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        // Add to page
        document.body.appendChild(notification);
        
        // Auto remove after 3 seconds
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 3000);
    }
})();
</script>
{% endblock %}

