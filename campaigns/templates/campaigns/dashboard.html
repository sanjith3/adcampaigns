{% extends 'base.html' %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                {% if show_follow %}
                    <i class="fas fa-bell"></i> Follow-up List
                {% else %}
                    My Ad Campaigns
                {% endif %}
            </h1>
            <div class="d-flex gap-2">
                {% if not user.is_superuser %}
                <a href="{% url 'create_ad' %}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> New Ad Enquiry
                </a>
                {% endif %}
                {% if show_follow %}
                    <a href="?" class="btn btn-outline-primary">
                        <i class="fas fa-chart-line"></i> Back to Dashboard
                    </a>
                {% else %}
                    <a href="?view=follow" class="btn btn-primary position-relative">
                        <i class="fas fa-bell"></i> Follow-up
                        <span id="user-follow-badge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="display:none;"></span>
                    </a>
                {% endif %}
                <a href="{% url 'user_day1_followup' %}" class="btn btn-outline-info">
                    <i class="fas fa-phone"></i> Day 1 Follow-ups
                </a>
                <a href="{% url 'user_day2_followup' %}" class="btn btn-outline-warning">
                    <i class="fas fa-phone-alt"></i> Day 2 Follow-ups
                </a>
                <!-- NEW: Enquiry History Button -->
                <a href="{% url 'enquiry_history' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-history"></i> Enquiry History
                </a>
            </div>
        </div>

        {% if not show_follow %}
        <!-- Status Filter Buttons -->
        <div class="card mb-3">
            <div class="card-body">
                <div class="btn-group" role="group">
                    <a href="?status=all" class="btn btn-outline-primary {% if status_filter == 'all' %}active{% endif %}">All</a>
                    <a href="?status=enquiry" class="btn btn-outline-secondary {% if status_filter == 'enquiry' %}active{% endif %}">Enquiry</a>
                    <a href="?status=hold" class="btn btn-outline-dark {% if status_filter == 'hold' %}active{% endif %}">Hold</a>
                    <a href="?status=pending" class="btn btn-outline-warning {% if status_filter == 'pending' %}active{% endif %}">Pending</a>
                    <a href="?status=active" class="btn btn-outline-success {% if status_filter == 'active' %}active{% endif %}">Active</a>
                    <a href="?status=completed" class="btn btn-outline-info {% if status_filter == 'completed' %}active{% endif %}">Completed</a>
                </div>
            </div>
        </div>

        <!-- Stats Row -->
        <div class="row mb-4">
            <!-- Monthly Stats Card -->
            <div class="col-md-3">
                <div class="card text-white bg-success">
                    <div class="card-body text-center">
                        <h5 class="card-title">{{ stats_active_today_count }}</h5>
                        <p class="card-text mb-0">Total Ads (This Month)</p>
                    </div>
                </div>
            </div>
            
            <!-- Monthly Amount Card -->
            <div class="col-md-3">
                <div class="card text-white bg-primary">
                    <div class="card-body text-center">
                        <h5 class="card-title">â‚¹{{ stats_active_today_amount }}</h5>
                        <p class="card-text mb-0">Amount (This Month)</p>
                    </div>
                </div>
            </div>
            
            <!-- Target Progress Card -->
            <div class="col-md-3">
                <div class="card text-white {% if target_progress.remaining <= 0 %}bg-success{% elif target_progress.progress_percentage >= 75 %}bg-warning{% else %}bg-info{% endif %}">
                    <div class="card-body text-center">
                        <h5 class="card-title">â‚¹{{ target_progress.achieved }} / â‚¹{{ target_progress.target }}</h5>
                        <p class="card-text mb-0">
                            {% if target_progress.remaining > 0 %}
                                â‚¹{{ target_progress.remaining }} to target
                            {% else %}
                                Target Achieved! ðŸŽ‰
                            {% endif %}
                        </p>
                        {% if target_progress.target > 0 %}
                        <div class="progress mt-2" style="height: 8px;">
                            <div class="progress-bar bg-dark" 
                                 role="progressbar" 
                                 style="width: {{ target_progress.progress_percentage }}%;"
                                 aria-valuenow="{{ target_progress.progress_percentage }}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                            </div>
                        </div>
                        <small class="mt-1 d-block">{{ target_progress.progress_percentage|floatformat:0 }}% Complete</small>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Date Range Filter Card -->
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <form method="get" class="row g-2 align-items-end">
                            <input type="hidden" name="status" value="{{ status_filter }}" />
                            <div class="col-12">
                                <label class="form-label">Start date</label>
                                <input type="date" name="start" value="{{ stats_range_start }}" class="form-control" />
                            </div>
                            <div class="col-12">
                                <label class="form-label">End date</label>
                                <input type="date" name="end" value="{{ stats_range_end }}" class="form-control" />
                            </div>
                            <div class="col-12 d-grid">
                                <button type="submit" class="btn btn-outline-primary">Filter Range</button>
                            </div>
                            {% if stats_range_count != None %}
                            <div class="col-12 mt-2">
                                <div class="alert alert-info py-2 mb-0 text-center">
                                    <strong>{{ stats_range_count }}</strong> ads in range<br>
                                    <strong>â‚¹{{ stats_range_amount }}</strong> total
                                </div>
                            </div>
                            {% endif %}
                        </form>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        {% if show_follow %}
        <!-- Follow-up Only View -->
        <div class="card mb-4 border-warning">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0"><i class="fas fa-bell"></i> Follow-up Required ({{ follow_up_ads.count }})</h5>
            </div>
            <div class="card-body">
                {% if follow_up_ads %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Ad Name</th>
                                <th>Business Name</th>
                                <th>Mobile Number</th>
                                <th>Completed Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ad in follow_up_ads %}
                            <tr>
                                <td>{{ ad.ad_name }}</td>
                                <td>{{ ad.business_name }}</td>
                                <td>{{ ad.mobile_number }}</td>
                                <td>{{ ad.end_date }}</td>
                                <td>
                                    <a href="{% url 'renew_ad' ad.id %}" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-sync"></i> Renew
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> No follow-ups needed.
                </div>
                {% endif %}
            </div>
        </div>
        {% else %}

        <!-- Active Ads -->
        {% if active_ads and status_filter == 'all' or active_ads and status_filter == 'active' %}
        <div class="card mb-4 border-success">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-play-circle"></i> Active Campaigns ({{ active_ads.count }})</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Ad Name</th>
                                <th>Business Name</th>
                                <th>Mobile Number</th>
                                <th>Start Date</th>
                                <th>End Date</th>
                                <th>Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ad in active_ads %}
                            <tr>
                                <td>{{ ad.ad_name }}</td>
                                <td>{{ ad.business_name }}</td>
                                <td>{{ ad.mobile_number }}</td>
                                <td>{{ ad.start_date }}</td>
                                <td>{{ ad.end_date }}</td>
                                <td>â‚¹{{ ad.amount }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Pending Verification -->
        {% if pending_ads and status_filter == 'all' or pending_ads and status_filter == 'pending' %}
        <div class="card mb-4 border-warning">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0"><i class="fas fa-clock"></i> Pending Verification ({{ pending_ads.count }})</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Ad Name</th>
                                <th>Business Name</th>
                                <th>Mobile Number</th>
                                <th>Amount</th>
                                <th>Last 4 UPI</th>
                                <th>Entry Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ad in pending_ads %}
                            <tr>
                                <td>{{ ad.ad_name }}</td>
                                <td>{{ ad.business_name }}</td>
                                <td>{{ ad.mobile_number }}</td>
                                <td>â‚¹{{ ad.amount }}</td>
                                <td>{{ ad.upi_last_four }}</td>
                                <td>{{ ad.entry_date|date:"M d, Y" }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Enquiries -->
        {% if enquiries and status_filter == 'all' or enquiries and status_filter == 'enquiry' %}
        <div class="card mb-4 border-secondary">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0"><i class="fas fa-question-circle"></i> Enquiries ({{ enquiries.count }})</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Ad Name</th>
                                <th>Business Name</th>  
                                <th>Mobile Number</th>
                                <th>Entry Date</th>
                                <th>Notes</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ad in enquiries %}
                            <tr>
                                <td>{{ ad.ad_name }}</td>
                                <td>{{ ad.business_name }}</td>
                                <td>{{ ad.mobile_number }}</td>
                                <td>{{ ad.entry_date|date:"M d, Y" }}</td>
                                <td>{{ ad.notes|truncatewords:10 }}</td>
                                <td>
                                    {% if not user.is_superuser %}
                                    <a href="{% url 'add_payment' ad.id %}" class="btn btn-sm btn-primary">
                                        <i class="fas fa-credit-card"></i> Add Payment
                                    </a>
                                    <a href="{% url 'edit_enquiry' ad.id %}" class="btn btn-sm btn-outline-secondary">
                                        <i class="fas fa-edit"></i> Edit
                                    </a>
                                    <!-- FIXED: Single modal approach -->
                                    <button class="btn btn-sm btn-outline-dark add-to-hold-btn" 
                                            data-ad-id="{{ ad.id }}"
                                            data-ad-name="{{ ad.ad_name }}"
                                            data-business-name="{{ ad.business_name }}">
                                        <i class="fas fa-pause"></i> Add to Hold
                                    </button>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Hold Ads -->
        {% if hold_ads and status_filter == 'all' or hold_ads and status_filter == 'hold' %}
        <div class="card mb-4 border-dark">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0"><i class="fas fa-pause"></i> On Hold ({{ hold_ads.count }})</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Ad Name</th>
                                <th>Business Name</th>
                                <th>Mobile Number</th>
                                <th>Reason</th>
                                <th>Hold Until</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ad in hold_ads %}
                            <tr>
                                <td>{{ ad.ad_name }}</td>
                                <td>{{ ad.business_name }}</td>
                                <td>{{ ad.mobile_number }}</td>
                                <td>{{ ad.hold_reason|default:'-' }}</td>
                                <td>{% if ad.hold_until %}{{ ad.hold_until|date:"M d, Y" }}{% else %}-{% endif %}</td>
                                <td>
                                    <a href="{% url 'add_payment' ad.id %}" class="btn btn-sm btn-primary">
                                        <i class="fas fa-credit-card"></i> Add Payment
                                    </a>
                                    <a href="{% url 'edit_hold' ad.id %}" class="btn btn-sm btn-outline-secondary">
                                        <i class="fas fa-edit"></i> Edit
                                    </a>
                                    <form method="post" action="{% url 'remove_hold' ad.id %}" style="display:inline;">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-sm btn-outline-secondary">
                                            <i class="fas fa-play"></i> Remove Hold
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Completed Ads -->
        {% if completed_ads and status_filter == 'all' or completed_ads and status_filter == 'completed' %}
        <div class="card mb-4 border-info">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-check-circle"></i> Completed Campaigns ({{ completed_ads.count }})</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Ad Name</th>
                                <th>Business Name</th>
                                <th>Mobile Number</th>
                                <th>Start Date</th>
                                <th>End Date</th>
                                <th>Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ad in completed_ads %}
                            <tr>
                                <td>{{ ad.ad_name }}</td>
                                <td>{{ ad.business_name }}</td>
                                <td>{{ ad.mobile_number }}</td>
                                <td>{{ ad.start_date }}</td>
                                <td>{{ ad.end_date }}</td>
                                <td>â‚¹{{ ad.amount }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}
        {% endif %}

        <!-- FIXED: Single Dynamic Hold Modal -->
        <div class="modal fade" id="holdModal" tabindex="-1" aria-labelledby="holdModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="holdModalLabel">Place on Hold</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <form method="post" id="holdForm" action="">
                        {% csrf_token %}
                        <div class="modal-body">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i>
                                Placing <strong id="holdAdName"></strong> - <strong id="holdBusinessName"></strong> on hold
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Reason</label>
                                <textarea name="hold_reason" rows="3" class="form-control" placeholder="Reason for hold" required></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Hold Until (optional)</label>
                                <input type="date" name="hold_until" class="form-control" />
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-dark">Confirm Hold</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
(function() {
    // FIXED: Single modal handler for hold buttons
    document.addEventListener('click', function(e) {
        const holdBtn = e.target.closest('.add-to-hold-btn');
        if (holdBtn) {
            e.preventDefault();
            
            const adId = holdBtn.getAttribute('data-ad-id');
            const adName = holdBtn.getAttribute('data-ad-name');
            const businessName = holdBtn.getAttribute('data-business-name');
            
            // Update modal content
            document.getElementById('holdAdName').textContent = adName;
            document.getElementById('holdBusinessName').textContent = businessName;
            
            // Update form action
            const form = document.getElementById('holdForm');
            form.action = `/dashboard/hold/${adId}/`;
            
            // Clear previous form data
            form.querySelector('textarea[name="hold_reason"]').value = '';
            form.querySelector('input[name="hold_until"]').value = '';
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('holdModal'));
            modal.show();
        }
    });

    // Cleanup stuck modals on page load
    document.addEventListener('DOMContentLoaded', function() {
        const hasVisibleModal = document.querySelector('.modal.show');
        if (!hasVisibleModal) {
            document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
                backdrop.remove();
            });
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
        }
    });

    const pollUrl = "{% url 'poll_user_status' %}";
    let currentToken = null;

    function scheduleNext(delayMs) {
        setTimeout(pollOnce, delayMs);
    }

    async function pollOnce() {
        try {
            const url = new URL(pollUrl, window.location.origin);
            if (currentToken) url.searchParams.set('token', currentToken);

            const resp = await fetch(url.toString(), { credentials: 'same-origin' });
            if (!resp.ok) throw new Error('Poll failed');

            const data = await resp.json();
            if (!data || typeof data.token !== 'string') throw new Error('Invalid response');

            // Reload page only if real change detected
            if (currentToken && data.changed) {
                window.location.reload();
                return; // stop further polling on this execution
            }

            currentToken = data.token; // update token
            scheduleNext(1000); // poll again after 1s

        } catch (e) {
            console.warn('User poll error:', e);
            scheduleNext(5000); // retry after 5s on error
        }
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', pollOnce);
    } else {
        pollOnce();
    }
})();
</script>
{% endblock %}