{% extends 'base.html' %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                {% if show_follow %}
                    <i class="fas fa-bell"></i> Follow-up List
                {% else %}
                    My Ad Campaigns
                {% endif %}
            </h1>
            <div class="d-flex gap-2">
                {% if not user.is_superuser %}
                <a href="{% url 'create_ad' %}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> New Ad Enquiry
                </a>
                {% endif %}
                {% if show_follow %}
                    <a href="?" class="btn btn-outline-primary">
                        <i class="fas fa-chart-line"></i> Back to Dashboard
                    </a>
                {% else %}
                    <a href="?view=follow" class="btn btn-primary position-relative">
                        <i class="fas fa-bell"></i> Follow-up
                        {% if follow_up_ads.count > 0 %}
                            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                                {{ follow_up_ads.count }}
                                <span class="visually-hidden">follow-ups needed</span>
                            </span>
                        {% endif %}
                    </a>
                {% endif %}
            </div>
        </div>

        {% if not show_follow %}
        <!-- Stats Row -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card text-white bg-success">
                    <div class="card-body text-center">
                        <h5 class="card-title">{{ stats_active_today_count }}</h5>
                        <p class="card-text mb-0">Active Today</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-white bg-primary">
                    <div class="card-body text-center">
                        <h5 class="card-title">₹{{ stats_active_today_amount }}</h5>
                        <p class="card-text mb-0">Amount Total (Today)</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title">Active Campaign History</h6>
                        <div class="mb-2">
                            <a href="?quick_filter=yesterday" class="btn btn-outline-warning btn-sm me-1 {% if quick_filter == 'yesterday' %}active{% endif %}">
                                Yesterday
                            </a>
                            <a href="?quick_filter=before_yesterday" class="btn btn-outline-warning btn-sm {% if quick_filter == 'before_yesterday' %}active{% endif %}">
                                Before Yesterday
                            </a>
                        </div>
                        <form method="get" class="row g-2 align-items-end">
                            <div class="col-5">
                                <label class="form-label">Start date</label>
                                <input type="date" name="start" value="{{ stats_range_start }}" class="form-control" />
                            </div>
                            <div class="col-5">
                                <label class="form-label">End date</label>
                                <input type="date" name="end" value="{{ stats_range_end }}" class="form-control" />
                            </div>
                            <div class="col-2 d-grid">
                                <button type="submit" class="btn btn-outline-primary">Filter</button>
                            </div>
                            {% if stats_range_count != None %}
                            <div class="col-12 mt-2">
                                <div class="alert alert-info py-2 mb-0">
                                    <strong>{{ stats_range_count }}</strong> active in range, total <strong>₹{{ stats_range_amount }}</strong>
                                </div>
                            </div>
                            {% endif %}
                        </form>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        {% if show_follow %}
        <!-- Follow-up Only View -->
        <div class="card mb-4 border-warning">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0"><i class="fas fa-bell"></i> Follow-up Required ({{ follow_up_ads.count }})</h5>
            </div>
            <div class="card-body">
                {% if follow_up_ads %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Ad Name</th>
                                <th>Business Name</th>
                                <th>Mobile Number</th>
                                <th>Completed Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ad in follow_up_ads %}
                            <tr>
                                <td>{{ ad.ad_name }}</td>
                                <td>{{ ad.business_name }}</td>
                                <td>{{ ad.mobile_number }}</td>
                                <td>{{ ad.end_date }}</td>
                                <td>
                                    <a href="{% url 'renew_ad' ad.id %}" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-sync"></i> Renew
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> No follow-ups needed.
                </div>
                {% endif %}
            </div>
        </div>
        {% else %}

        <!-- Active Ads -->
        {% if active_ads %}
        <div class="card mb-4 border-success">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-play-circle"></i> Active Campaigns</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Ad Name</th>
                                <th>Business Name</th>
                                <th>Mobile Number</th>
                                <th>Start Date</th>
                                <th>End Date</th>
                                <th>Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ad in active_ads %}
                            <tr>
                                <td>{{ ad.ad_name }}</td>
                                <td>{{ ad.business_name }}</td>
                                <td>{{ ad.mobile_number }}</td>
                                <td>{{ ad.start_date }}</td>
                                <td>{{ ad.end_date }}</td>
                                <td>₹{{ ad.amount }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Pending Verification -->
        {% if pending_ads %}
        <div class="card mb-4 border-warning">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0"><i class="fas fa-clock"></i> Pending Verification</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Ad Name</th>
                                <th>Business Name</th>
                                <th>Mobile Number</th>
                                <th>Amount</th>
                                <th>Last 4 UPI</th>
                                <th>Entry Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ad in pending_ads %}
                            <tr>
                                <td>{{ ad.ad_name }}</td>
                                <td>{{ ad.business_name }}</td>
                                <td>{{ ad.mobile_number }}</td>
                                <td>₹{{ ad.amount }}</td>
                                <td>{{ ad.upi_last_four }}</td>
                                <td>{{ ad.entry_date|date:"M d, Y" }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Enquiries -->
        {% if enquiries %}
        <div class="card mb-4 border-secondary">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0"><i class="fas fa-question-circle"></i> Enquiries</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Ad Name</th>
                                <th>Business Name</th>  
                                <th>Mobile Number</th>
                                <th>Entry Date</th>
                                <th>Notes</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ad in enquiries %}
                            <tr>
                                <td>{{ ad.ad_name }}</td>
                                <td>{{ ad.business_name }}</td>
                                <td>{{ ad.mobile_number }}</td>
                                <td>{{ ad.entry_date|date:"M d, Y" }}</td>
                                <td>{{ ad.notes|truncatewords:10 }}</td>
                                <td>
                                    {% if not user.is_superuser %}
                                    <a href="{% url 'add_payment' ad.id %}" class="btn btn-sm btn-primary">
                                        <i class="fas fa-credit-card"></i> Add Payment
                                    </a>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Active Campaign History Table -->
        {% if quick_filter == 'yesterday' or quick_filter == 'before_yesterday' %}
        <div class="card mb-4 border-success">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-play-circle"></i> 
                    {% if quick_filter == 'yesterday' %}
                        Active Campaigns Yesterday
                    {% elif quick_filter == 'before_yesterday' %}
                        Active Campaigns Before Yesterday
                    {% endif %}
                    ({{ stats_range_count }})
                </h5>
            </div>
            <div class="card-body">
                {% if stats_range_count > 0 %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Ad Name</th>
                                <th>Business Name</th>
                                <th>Start Date</th>
                                <th>End Date</th>
                                <th>Amount</th>
                                <th>Duration</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ad in active_ads %}
                                {% if quick_filter == 'yesterday' %}
                                    {% if ad.start_date <= yesterday and ad.end_date >= yesterday %}
                                    <tr>
                                        <td>{{ ad.ad_name }}</td>
                                        <td>{{ ad.business_name }}</td>
                                        <td>{{ ad.start_date|date:"M d, Y" }}</td>
                                        <td>{{ ad.end_date|date:"M d, Y" }}</td>
                                        <td>₹{{ ad.amount }}</td>
                                        <td>{{ ad.get_duration_days }} days</td>
                                    </tr>
                                    {% endif %}
                                {% elif quick_filter == 'before_yesterday' %}
                                    {% if ad.start_date <= before_yesterday and ad.end_date >= before_yesterday %}
                                    <tr>
                                        <td>{{ ad.ad_name }}</td>
                                        <td>{{ ad.business_name }}</td>
                                        <td>{{ ad.start_date|date:"M d, Y" }}</td>
                                        <td>{{ ad.end_date|date:"M d, Y" }}</td>
                                        <td>₹{{ ad.amount }}</td>
                                        <td>{{ ad.get_duration_days }} days</td>
                                    </tr>
                                    {% endif %}
                                {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> No active campaigns found for this date.
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Completed Ads -->
        {% if completed_ads %}
        <div class="card mb-4 border-info">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-check-circle"></i> Completed Campaigns</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Ad Name</th>
                                <th>Business Name</th>
                                <th>Mobile Number</th>
                                <th>Start Date</th>
                                <th>End Date</th>
                                <th>Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ad in completed_ads %}
                            <tr>
                                <td>{{ ad.ad_name }}</td>
                                <td>{{ ad.business_name }}</td>
                                <td>{{ ad.mobile_number }}</td>
                                <td>{{ ad.start_date }}</td>
                                <td>{{ ad.end_date }}</td>
                                <td>₹{{ ad.amount }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}
        {% endif %}
    </div>
</div>
{% endblock %}